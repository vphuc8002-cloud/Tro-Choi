<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i 21: Qu·∫ßn th·ªÉ sinh v·∫≠t</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap');
        body { font-family: 'Lexend', sans-serif; background-color: #f1f5f9; }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid #e2e8f0; }
        .option-btn { transition: all 0.2s; cursor: pointer; border: 2px solid #f1f5f9; }
        .option-btn:hover:not(:disabled) { border-color: #10b981; background-color: #f0fdf4; }
        .option-selected { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
        .correct { background-color: #10b981 !important; color: white !important; border-color: #059669 !important; }
        .wrong { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        .timer-bar { transition: width 0.1s linear; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-slate-800">

    <div class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="max-w-3xl w-full">
            
            <!-- Header Status -->
            <div id="quiz-header" class="hidden flex justify-between items-center mb-6 glass-card p-5 rounded-2xl shadow-sm border-t-4 border-emerald-500">
                <div class="flex-1 border-r border-slate-100 mr-4">
                    <span id="question-counter" class="text-sm font-bold text-slate-400 uppercase tracking-widest">C√¢u 1 / 45</span>
                </div>
                <div class="text-right">
                    <span id="display-name" class="text-[10px] font-bold text-slate-400 uppercase block leading-tight">Ng∆∞·ªùi ch∆°i</span>
                    <div class="text-2xl font-black text-emerald-600" id="score-display">0</div>
                </div>
            </div>

            <div id="quiz-area" class="glass-card rounded-3xl shadow-2xl p-8 min-h-[520px] relative overflow-hidden flex flex-col">
                
                <!-- Welcome Screen -->
                <div id="start-screen" class="text-center py-6 flex-1 flex flex-col">
                    <div class="text-5xl mb-4">üåø</div>
                    <h1 class="text-3xl font-bold text-slate-900 mb-6">B√†i 21: Qu·∫ßn th·ªÉ sinh v·∫≠t</h1>
                    
                    <div class="flex-1 bg-slate-50 rounded-2xl p-4 mb-6 border border-slate-200 overflow-hidden flex flex-col">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-[10px] font-black text-slate-400 uppercase">B·∫£ng th√†nh t√≠ch</h3>
                            <span id="online-status" class="text-[9px] text-emerald-500 font-bold hidden">‚óè Tr·ª±c tuy·∫øn</span>
                        </div>
                        <div id="leaderboard-list" class="flex-1 overflow-y-auto pr-2 space-y-2 scrollbar-hide">
                            <p class="text-slate-400 text-sm italic py-10 text-center">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                        </div>
                    </div>

                    <div class="max-w-xs mx-auto mb-4 w-full">
                        <input type="text" id="player-name-input" maxlength="15" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" 
                               class="w-full px-5 py-4 rounded-xl border-2 border-slate-100 focus:border-emerald-500 focus:outline-none text-center font-bold text-lg shadow-sm">
                        <p id="name-error" class="text-red-500 text-[10px] font-bold mt-2 hidden">T√™n n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!</p>
                    </div>

                    <button id="start-btn" class="px-10 py-4 bg-emerald-600 text-white rounded-xl font-bold text-lg hover:bg-emerald-700 transition-all shadow-lg w-full max-w-xs mx-auto active:scale-95">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                </div>

                <!-- Question Screen -->
                <div id="question-screen" class="hidden flex-1 flex flex-col">
                    <div id="timer-container" class="w-full bg-slate-200 h-2 rounded-full mb-6 overflow-hidden">
                        <div id="timer-bar" class="timer-bar bg-emerald-500 h-full w-full"></div>
                    </div>
                    <h2 id="question-text" class="text-xl font-bold text-slate-800 mb-8 leading-snug"></h2>
                    <div id="options-grid" class="grid grid-cols-1 gap-3 mb-8"></div>
                    
                    <div class="mt-auto flex items-center justify-between border-t pt-6 border-slate-100">
                        <div id="feedback-msg" class="text-sm font-bold"></div>
                        <div class="flex gap-3">
                            <button id="submit-btn" class="hidden px-8 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition shadow-md">X√°c nh·∫≠n</button>
                            <button id="next-btn" class="hidden px-8 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-black transition shadow-md">Ti·∫øp t·ª•c</button>
                        </div>
                    </div>
                </div>

                <!-- Result Screen -->
                <div id="result-screen" class="hidden text-center py-6 flex flex-col flex-1">
                    <div id="result-icon" class="text-6xl mb-4">üèÜ</div>
                    <h2 id="result-title" class="text-2xl font-bold mb-1">K·∫øt th√∫c b√†i l√†m</h2>
                    <h3 class="text-lg font-bold text-slate-500 mb-2" id="final-name-display"></h3>
                    <p id="final-score" class="text-6xl font-black text-emerald-600 mb-2">0/45</p>
                    <p id="violation-msg" class="text-red-500 font-bold text-sm mb-4 hidden">‚ö†Ô∏è T·ª± ƒë·ªông n·ªôp b√†i do r·ªùi kh·ªèi trang!</p>
                    
                    <div class="flex-1 bg-slate-50 rounded-2xl p-4 mb-8 border border-slate-200 overflow-hidden">
                         <p class="text-[10px] font-black text-slate-400 uppercase mb-3">Th√†nh t√≠ch ghi nh·∫≠n</p>
                         <div id="final-leaderboard" class="space-y-1 max-h-48 overflow-y-auto scrollbar-hide"></div>
                    </div>

                    <button id="back-home-btn" class="px-10 py-4 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition w-full max-w-xs mx-auto shadow-lg">L√†m l·∫°i b√†i m·ªõi</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, serverTimestamp, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Quiz Constants
        const TOTAL_QS = 45;
        const TIME_LIMIT = 15;

        const questionsData = [
            { type: 'single', q: "Theo ƒë·ªãnh nghƒ©a, qu·∫ßn th·ªÉ sinh v·∫≠t l√† t·∫≠p h·ª£p c√°c c√° th·ªÉ:", a: ["Kh√°c lo√†i, s·ªëng c√πng n∆°i, c√πng th·ªùi ƒëi·ªÉm.", "C√πng lo√†i, c√πng s·ªëng trong kho·∫£ng kh√¥ng gian v√† th·ªùi gian x√°c ƒë·ªãnh.", "C√πng lo√†i nh∆∞ng s·ªëng ·ªü c√°c khu v·ª±c ƒë·ªãa l√Ω kh√°c bi·ªát.", "Nhi·ªÅu lo√†i c√≥ m·ªëi quan h·ªá ƒÉn th·ªãt l·∫´n nhau."], correct: 1 },
            { type: 'truefalse', q: "Qu·∫ßn th·ªÉ sinh v·∫≠t l√† m·ªôt ƒë∆°n v·ªã di truy·ªÅn, c√≥ v·ªën gene ƒë·∫∑c tr∆∞ng.", a: ["ƒê√∫ng", "Sai"], correct: 0 },
            { type: 'single', q: "C√°c c√° th·ªÉ c√πng lo√†i trong qu·∫ßn th·ªÉ c√≥ kh·∫£ nƒÉng g√¨ ƒë·ªÉ t·∫°o ra th·∫ø h·ªá m·ªõi?", a: ["C·∫°nh tranh gay g·∫Øt.", "S·ªëng k√≠ sinh l·∫´n nhau.", "Giao ph·ªëi t·ª± do v√† sinh con h·ªØu th·ª•.", "Ch·ªâ s·ªëng chung m·ªôt khu v·ª±c."], correct: 2 },
            { type: 'multi', q: "ƒê√¢u l√† v√≠ d·ª• v·ªÅ quan h·ªá h·ªó tr·ª£ trong qu·∫ßn th·ªÉ? (Ch·ªçn c√°c √Ω ƒë√∫ng)", a: ["Th·ª±c v·∫≠t s·ªëng th√†nh c·ª•m ch·∫Øn gi√≥ b√£o.", "Hi·ªán t∆∞·ª£ng li·ªÅn r·ªÖ ·ªü c√¢y th√¥ng.", "C√°c con ƒë·ª±c tranh gi√†nh con c√°i m√πa sinh s·∫£n.", "Ch√≥ s√≥i sƒÉn m·ªìi theo b·∫ßy ƒë√†n."], correct: [0, 1, 3] },
            { type: 'single', q: "Hi·ªán t∆∞·ª£ng 't·ª± t·ªâa th∆∞a' ·ªü th·ª±c v·∫≠t l√† k·∫øt qu·∫£ c·ªßa m·ªëi quan h·ªá n√†o?", a: ["H·ªó tr·ª£ c√πng lo√†i.", "C·∫°nh tranh c√πng lo√†i.", "V·∫≠t ƒÉn th·ªãt - con m·ªìi.", "C·ªông sinh."], correct: 1 },
            { type: 'truefalse', q: "Quan h·ªá c·∫°nh tranh c√πng lo√†i l√† ƒë·ªông l·ª±c th√∫c ƒë·∫©y s·ª± ti·∫øn h√≥a.", a: ["ƒê√∫ng", "Sai"], correct: 0 },
            { type: 'single', q: "K√≠ch th∆∞·ªõc t·ªëi thi·ªÉu c·ªßa qu·∫ßn th·ªÉ l√†:", a: ["S·ªë l∆∞·ª£ng c√° th·ªÉ √≠t nh·∫•t ƒë·ªÉ qu·∫ßn th·ªÉ duy tr√¨ v√† ph√°t tri·ªÉn.", "S·ªë l∆∞·ª£ng c√° th·ªÉ l·ªõn nh·∫•t m√¥i tr∆∞·ªùng c√≥ th·ªÉ nu√¥i d∆∞·ª°ng.", "S·ªë l∆∞·ª£ng c√° th·ªÉ trung b√¨nh trong 10 nƒÉm.", "S·ªë l∆∞·ª£ng c√° th·ªÉ khi ngu·ªìn s·ªëng d·ªìi d√†o nh·∫•t."], correct: 0 },
            { type: 'multi', q: "H·∫≠u qu·∫£ khi qu·∫ßn th·ªÉ gi·∫£m xu·ªëng d∆∞·ªõi m·ª©c t·ªëi thi·ªÉu l√† g√¨?", a: ["Kh·∫£ nƒÉng h·ªó tr·ª£ gi·∫£m s√∫t.", "D·ªÖ x·∫£y ra giao ph·ªëi c·∫≠n huy·∫øt.", "Kh·∫£ nƒÉng g·∫∑p g·ª° ƒë·ª±c - c√°i ƒë·ªÉ sinh s·∫£n th·∫•p.", "T·ªëc ƒë·ªô tƒÉng tr∆∞·ªüng ƒë·∫°t t·ªëi ƒëa."], correct: [0, 1, 2] },
            { type: 'single', q: "ƒê·∫∑c tr∆∞ng n√†o ƒë∆∞·ª£c coi l√† c∆° b·∫£n nh·∫•t ·∫£nh h∆∞·ªüng ƒë·∫øn m·ª©c s·ª≠ d·ª•ng ngu·ªìn s·ªëng?", a: ["T·ªâ l·ªá gi·ªõi t√≠nh.", "Nh√≥m tu·ªïi.", "M·∫≠t ƒë·ªô c√° th·ªÉ.", "Ki·ªÉu ph√¢n b·ªë."], correct: 2 },
            { type: 'truefalse', q: "T·ªâ l·ªá gi·ªõi t√≠nh trong qu·∫ßn th·ªÉ lu√¥n lu√¥n c·ªë ƒë·ªãnh ·ªü m·ª©c 1:1 trong m·ªçi ƒëi·ªÅu ki·ªán.", a: ["ƒê√∫ng", "Sai"], correct: 1 },
            { type: 'single', q: "Nh√≥m tu·ªïi n√†o quy·∫øt ƒë·ªãnh s·ª± ph√°t tri·ªÉn k√≠ch th∆∞·ªõc qu·∫ßn th·ªÉ trong t∆∞∆°ng lai?", a: ["Nh√≥m tr∆∞·ªõc sinh s·∫£n.", "Nh√≥m ƒëang sinh s·∫£n.", "Nh√≥m sau sinh s·∫£n.", "C·∫£ 3 nh√≥m nh∆∞ nhau."], correct: 0 },
            { type: 'single', q: "Ki·ªÉu ph√¢n b·ªë c√° th·ªÉ ph·ªï bi·∫øn nh·∫•t trong t·ª± nhi√™n l√†:", a: ["Ph√¢n b·ªë ƒë·ªìng ƒë·ªÅu.", "Ph√¢n b·ªë ng·∫´u nhi√™n.", "Ph√¢n b·ªë theo nh√≥m.", "Ph√¢n b·ªë theo t·∫ßng."], correct: 2 },
            { type: 'single', q: "√ù nghƒ©a c·ªßa ph√¢n b·ªë ƒë·ªìng ƒë·ªÅu l√†:", a: ["H·ªó tr·ª£ nhau ch·ªëng l·∫°i ƒëi·ªÅu ki·ªán b·∫•t l·ª£i.", "Gi·∫£m s·ª± c·∫°nh tranh gi·ªØa c√°c c√° th·ªÉ.", "T·∫≠n d·ª•ng t·ªëi ƒëa ngu·ªìn s·ªëng m√¥i tr∆∞·ªùng.", "TƒÉng c∆∞·ªùng kh·∫£ nƒÉng giao ph·ªëi."], correct: 1 },
            { type: 'single', q: "ƒê∆∞·ªùng cong tƒÉng tr∆∞·ªüng h√¨nh ch·ªØ J x·∫£y ra khi n√†o?", a: ["M√¥i tr∆∞·ªùng b·ªã gi·ªõi h·∫°n ngu·ªìn s·ªëng.", "M√¥i tr∆∞·ªùng kh√¥ng b·ªã gi·ªõi h·∫°n (d·ªìi d√†o, kh√¥ng k·∫ª th√π).", "Qu·∫ßn th·ªÉ ƒëang ·ªü m·ª©c t·ªëi ƒëa.", "Khi c√≥ d·ªãch b·ªánh b√πng ph√°t."], correct: 1 },
            { type: 'multi', q: "Bi·∫øn ƒë·ªông s·ªë l∆∞·ª£ng c√° th·ªÉ kh√¥ng theo chu k√¨ do nh√¢n t·ªë n√†o?", a: ["Thi√™n tai (l≈© l·ª•t, ch√°y r·ª´ng).", "S·ª± thay ƒë·ªïi c·ªßa m√πa trong nƒÉm.", "S·ª± can thi·ªáp c·ªßa con ng∆∞·ªùi.", "D·ªãch b·ªánh b·∫•t ng·ªù."], correct: [0, 2, 3] },
            { type: 'single', q: "Qu·∫ßn th·ªÉ ng∆∞·ªùi kh√°c qu·∫ßn th·ªÉ sinh v·∫≠t kh√°c ·ªü ƒëi·ªÉm c·ªët l√µi n√†o?", a: ["C√≥ c·∫•u tr√∫c nh√≥m tu·ªïi.", "B·ªã chi ph·ªëi b·ªüi c√°c nh√¢n t·ªë kinh t·∫ø - x√£ h·ªôi, vƒÉn h√≥a.", "C√≥ kh·∫£ nƒÉng sinh s·∫£n.", "C√≥ s·ª± c·∫°nh tranh ngu·ªìn s·ªëng."], correct: 1 },
            { type: 'truefalse', q: "Gia tƒÉng d√¢n s·ªë qu√° nhanh d·∫´n ƒë·∫øn c·∫°n ki·ªát t√†i nguy√™n v√† √¥ nhi·ªÖm m√¥i tr∆∞·ªùng.", a: ["ƒê√∫ng", "Sai"], correct: 0 },
            { type: 'single', q: "Trong n√¥ng nghi·ªáp, vi·ªác t√≠nh to√°n m·∫≠t ƒë·ªô nu√¥i th·∫£ ph√π h·ª£p nh·∫±m:", a: ["TƒÉng c·∫°nh tranh gi·ªØa c√°c c√° th·ªÉ.", "ƒê·∫°t nƒÉng su·∫•t cao nh·∫•t, gi·∫£m c·∫°nh tranh, t·∫≠n d·ª•ng ngu·ªìn s·ªëng.", "L√†m gi·∫£m kh·∫£ nƒÉng ph·ª•c h·ªìi c·ªßa qu·∫ßn th·ªÉ.", "Ti·∫øt ki·ªám con gi·ªëng t·ªëi ƒëa."], correct: 1 },
            { type: 'single', q: "Nguy√™n t·∫Øc khai th√°c h·∫£i s·∫£n b·ªÅn v·ªØng l√†:", a: ["ƒê√°nh b·∫Øt v√†o m√πa sinh s·∫£n ƒë·ªÉ c√≥ s·∫£n l∆∞·ª£ng cao.", "Khai th√°c tri·ªát ƒë·ªÉ c·∫£ c√° nh·ªè.", "Ch·ªâ khai th√°c ·ªü m·ª©c ƒë·ªô cho ph√©p, ƒë√∫ng k√≠ch th∆∞·ªõc l∆∞·ªõi v√† ƒë√∫ng m√πa.", "Khai th√°c m·∫°nh khi qu·∫ßn th·ªÉ d∆∞·ªõi m·ª©c t·ªëi thi·ªÉu."], correct: 2 },
            { type: 'truefalse', q: "ƒê·ªÉ b·∫£o t·ªìn lo√†i qu√Ω hi·∫øm, c·∫ßn duy tr√¨ k√≠ch th∆∞·ªõc qu·∫ßn th·ªÉ tr√™n m·ª©c t·ªëi thi·ªÉu.", a: ["ƒê√∫ng", "Sai"], correct: 0 },
            { type: 'single', q: "C·∫•u tr√∫c th√°p tu·ªïi c√≥ ƒë√°y r·ªông, c·∫°nh xi√™n m·∫°nh l√™n tr√™n l√† th√°p:", a: ["·ªîn ƒë·ªãnh.", "Suy tho√°i.", "Ph√°t tri·ªÉn.", "C√¢n b·∫±ng."], correct: 2 },
            { type: 'single', q: "M·ªëi quan h·ªá n√†o gi√∫p c√°c c√° th·ªÉ th·ª±c v·∫≠t li·ªÅn r·ªÖ trao ƒë·ªïi mu·ªëi kho√°ng?", a: ["H·ªó tr·ª£ c√πng lo√†i.", "C·∫°nh tranh c√πng lo√†i.", "K√≠ sinh.", "H·ªôi sinh."], correct: 0 },
            { type: 'truefalse', q: "M·∫≠t ƒë·ªô c√° th·ªÉ ƒë∆∞·ª£c ƒëi·ªÅu h√≤a quanh m·ª©c c√¢n b·∫±ng nh·ªù h·ªó tr·ª£ v√† c·∫°nh tranh.", a: ["ƒê√∫ng", "Sai"], correct: 0 },
            { type: 'multi', q: "C√°c nh√¢n t·ªë l√†m thay ƒë·ªïi k√≠ch th∆∞·ªõc qu·∫ßn th·ªÉ bao g·ªìm?", a: ["M·ª©c ƒë·ªô sinh s·∫£n.", "M·ª©c ƒë·ªô t·ª≠ vong.", "S·ª± ph√°t t√°n (nh·∫≠p c∆∞, di c∆∞).", "S·ª± thay ƒë·ªïi m√†u s·∫Øc c√° th·ªÉ."], correct: [0, 1, 2] },
            { type: 'single', q: "Khi m·∫≠t ƒë·ªô c√° th·ªÉ tƒÉng qu√° cao, th·ª©c ƒÉn khan hi·∫øm s·∫Ω d·∫´n ƒë·∫øn:", a: ["H·ªó tr·ª£ tƒÉng m·∫°nh.", "C·∫°nh tranh tƒÉng, t·ª≠ vong tƒÉng.", "Sinh s·∫£n tƒÉng ƒë·ªôt bi·∫øn.", "K√≠ch th∆∞·ªõc c√° th·ªÉ tƒÉng."], correct: 1 },
            { type: 'single', q: "Ph√¢n b·ªë ng·∫´u nhi√™n gi√∫p sinh v·∫≠t:", a: ["H·ªó tr·ª£ nhau t·ªët nh·∫•t.", "Gi·∫£m c·∫°nh tranh t·ªëi ƒëa.", "T·∫≠n d·ª•ng ngu·ªìn s·ªëng c·ªßa m√¥i tr∆∞·ªùng.", "B·∫£o v·ªá l√£nh th·ªï t·ªët nh·∫•t."], correct: 2 },
            { type: 'truefalse', q: "Qu·∫ßn th·ªÉ l√† ƒë∆°n v·ªã nh·ªè nh·∫•t c√≥ kh·∫£ nƒÉng t·ªìn t·∫°i, sinh s·∫£n v√† ti·∫øn h√≥a ƒë·ªôc l·∫≠p theo th·ªùi gian.", a: ["ƒê√∫ng", "Sai"], correct: 0 },
            { type: 'single', q: "Chu k√¨ bi·∫øn ƒë·ªông c·ªßa v·∫≠t ƒÉn th·ªãt v√† con m·ªìi l√† v√≠ d·ª• c·ªßa:", a: ["Bi·∫øn ƒë·ªông kh√¥ng theo chu k√¨.", "Bi·∫øn ƒë·ªông theo chu k√¨.", "S·ª± tƒÉng tr∆∞·ªüng ch·ªØ J.", "S·ª± suy tho√°i qu·∫ßn th·ªÉ."], correct: 1 },
            { type: 'single', q: "Y·∫øu t·ªë then ch·ªët ƒë·ªÉ ƒë·∫£m b·∫£o s·ª± ph√°t tri·ªÉn b·ªÅn v·ªØng ·ªü qu·∫ßn th·ªÉ ng∆∞·ªùi l√†:", a: ["TƒÉng c∆∞·ªùng khai th√°c t√†i nguy√™n.", "Ki·ªÉm so√°t gia tƒÉng d√¢n s·ªë.", "M·ªü r·ªông di·ªán t√≠ch s·ªëng sang h√†nh tinh kh√°c.", "T·ª± t·ªâa th∆∞a t·ª± nhi√™n."], correct: 1 },
            { type: 'multi', q: "·ª®ng d·ª•ng ki·∫øn th·ª©c qu·∫ßn th·ªÉ trong b·∫£o t·ªìn bao g·ªìm?", a: ["X√¢y d·ª±ng k·∫ø ho·∫°ch b·∫£o v·ªá lo√†i qu√Ω hi·∫øm.", "Duy tr√¨ m√¥i tr∆∞·ªùng s·ªëng an to√†n.", "Khai th√°c tri·ªát ƒë·ªÉ c√° th·ªÉ gi√†.", "Ki·ªÉm so√°t c√°c lo√†i g√¢y h·∫°i b·∫±ng bi·ªán ph√°p sinh h·ªçc."], correct: [0, 1, 3] },
            { type: 'single', q: "T·∫≠p h·ª£p n√†o sau ƒë√¢y KH√îNG ph·∫£i l√† m·ªôt qu·∫ßn th·ªÉ sinh v·∫≠t?", a: ["C√°c c√¢y th√¥ng ba l√° tr√™n m·ªôt ƒë·ªìi th√¥ng.", "C√°c con c√° trong m·ªôt h·ªì T√¢y.", "C√°c con h∆∞∆°u sao trong m·ªôt khu r·ª´ng.", "C√°c con chim b·ªì c√¢u trong m·ªôt th√†nh ph·ªë."], correct: 1 },
            { type: 'single', q: "S·ª± h·ªó tr·ª£ gi·ªØa c√°c c√° th·ªÉ c√πng lo√†i gi√∫p sinh v·∫≠t:", a: ["Khai th√°c t·ªët ngu·ªìn s·ªëng v√† tƒÉng kh·∫£ nƒÉng s·ªëng s√≥t.", "TƒÉng s·ª± c·∫°nh tranh gi√†nh th·ª©c ƒÉn.", "L√†m gi·∫£m m·∫≠t ƒë·ªô c√° th·ªÉ trong qu·∫ßn th·ªÉ.", "H·∫°n ch·∫ø kh·∫£ nƒÉng sinh s·∫£n c·ªßa c√°c c√° th·ªÉ y·∫øu."], correct: 0 },
            { type: 'truefalse', q: "Khi m·∫≠t ƒë·ªô qu·∫ßn th·ªÉ v∆∞·ª£t qu√° s·ª©c ch·ªãu ƒë·ª±ng c·ªßa m√¥i tr∆∞·ªùng, c·∫°nh tranh s·∫Ω tr·ªü n√™n gay g·∫Øt.", a: ["ƒê√∫ng", "Sai"], correct: 0 },
            { type: 'single', q: "Trong qu·∫ßn th·ªÉ, s·ª± ph√¢n b·ªë c√° th·ªÉ ƒë·ªìng ƒë·ªÅu gi√∫p:", a: ["T·∫≠n d·ª•ng ngu·ªìn s·ªëng d·ªìi d√†o nh·∫•t.", "Gi·∫£m s·ª± c·∫°nh tranh gi·ªØa c√°c c√° th·ªÉ.", "H·ªó tr·ª£ nhau ch·ªëng l·∫°i k·∫ª th√π.", "TƒÉng kh·∫£ nƒÉng giao ph·ªëi gi·ªØa c√°c c√° th·ªÉ."], correct: 1 },
            { type: 'single', q: "K√≠ch th∆∞·ªõc t·ªëi ƒëa c·ªßa qu·∫ßn th·ªÉ ph·ª• thu·ªôc ch·ªß y·∫øu v√†o:", a: ["S·ªë l∆∞·ª£ng c√° th·ªÉ ch·∫øt ƒëi.", "Kh·∫£ nƒÉng cung c·∫•p ngu·ªìn s·ªëng c·ªßa m√¥i tr∆∞·ªùng.", "T·ªëc ƒë·ªô di c∆∞ c·ªßa c√°c c√° th·ªÉ.", "T·ªâ l·ªá gi·ªõi t√≠nh c·ªßa qu·∫ßn th·ªÉ."], correct: 1 },
            { type: 'multi', q: "ƒê√¢u l√† nh√¢n t·ªë h·ªØu sinh g√¢y bi·∫øn ƒë·ªông s·ªë l∆∞·ª£ng qu·∫ßn th·ªÉ?", a: ["V·∫≠t ƒÉn th·ªãt.", "V·∫≠t k√≠ sinh.", "L≈© l·ª•t.", "C·∫°nh tranh c√πng lo√†i."], correct: [0, 1, 3] },
            { type: 'single', q: "TƒÉng tr∆∞·ªüng d√¢n s·ªë ·ªü c√°c n∆∞·ªõc ƒëang ph√°t tri·ªÉn th∆∞·ªùng c√≥ ƒë·∫∑c ƒëi·ªÉm:", a: ["D·∫°ng th√°p ·ªïn ƒë·ªãnh.", "D·∫°ng th√°p suy tho√°i.", "D·∫°ng th√°p ph√°t tri·ªÉn (ƒë√°y r·ªông).", "D·∫°ng th√°p c√¢n ƒë·ªëi."], correct: 2 },
            { type: 'truefalse', q: "Nh√≥m tu·ªïi sau sinh s·∫£n c√≥ vai tr√≤ quy·∫øt ƒë·ªãnh m·ª©c ƒë·ªô sinh s·∫£n c·ªßa qu·∫ßn th·ªÉ.", a: ["ƒê√∫ng", "Sai"], correct: 1 },
            { type: 'single', q: "Tr∆∞·ªùng h·ª£p n√†o sau ƒë√¢y c√≥ ƒë·ªì th·ªã tƒÉng tr∆∞·ªüng h√¨nh ch·ªØ J?", a: ["ƒê·ªông v·∫≠t trong r·ª´ng nguy√™n sinh.", "Vi khu·∫©n trong m√¥i tr∆∞·ªùng nu√¥i c·∫•y d·ªìi d√†o dinh d∆∞·ª°ng.", "C√° trong h·ªì b·ªã ƒë√°nh b·∫Øt qu√° m·ª©c.", "Th·ª±c v·∫≠t tr√™n ƒë·ªìng c·ªè kh√¥ h·∫°n."], correct: 1 },
            { type: 'single', q: "Nh√¢n t·ªë sinh th√°i n√†o sau ƒë√¢y l√† nh√¢n t·ªë ph·ª• thu·ªôc m·∫≠t ƒë·ªô?", a: ["Nhi·ªát ƒë·ªô m√¥i tr∆∞·ªùng.", "√Ånh s√°ng m·∫∑t tr·ªùi.", "S·ª± c·∫°nh tranh ngu·ªìn s·ªëng.", "ƒê·ªô ·∫©m kh√¥ng kh√≠."], correct: 2 },
            { type: 'single', q: "√ù nghƒ©a th·ª±c ti·ªÖn c·ªßa vi·ªác nghi√™n c·ª©u c·∫•u tr√∫c tu·ªïi l√†:", a: ["ƒê·ªÉ bi·∫øt qu·∫ßn th·ªÉ ƒëang gi√†u hay ngh√®o.", "ƒê·ªÉ b·∫£o v·ªá c√°c c√° th·ªÉ gi√†.", "ƒê·ªÉ d·ª± b√°o bi·∫øn ƒë·ªông s·ªë l∆∞·ª£ng v√† khai th√°c h·ª£p l√≠.", "ƒê·ªÉ tƒÉng m·∫≠t ƒë·ªô c√° th·ªÉ l√™n m·ª©c t·ªëi ƒëa."], correct: 2 },
            { type: 'truefalse', q: "·ªû m·ªôt s·ªë lo√†i r√πa, nhi·ªát ƒë·ªô ·∫•p tr·ª©ng quy·∫øt ƒë·ªãnh gi·ªõi t√≠nh c·ªßa c√° th·ªÉ con.", a: ["ƒê√∫ng", "Sai"], correct: 0 },
            { type: 'single', q: "Bi·∫øn ƒë·ªông s·ªë l∆∞·ª£ng c√° th·ªÉ theo chu k√¨ m√πa th∆∞·ªùng g·∫∑p ·ªü c√°c lo√†i:", a: ["C√≥ tu·ªïi th·ªç cao.", "C√≥ k√≠ch th∆∞·ªõc c∆° th·ªÉ l·ªõn.", "V√≤ng ƒë·ªùi ng·∫Øn, sinh s·∫£n nhanh.", "Di c∆∞ t·ª´ xa ƒë·∫øn."], correct: 2 },
            { type: 'multi', q: "Khai th√°c t√†i nguy√™n b·ªÅn v·ªØng c·∫ßn d·ª±a tr√™n c√°c ƒë·∫∑c tr∆∞ng n√†o?", a: ["K√≠ch th∆∞·ªõc t·ªëi thi·ªÉu.", "K√≠ch th∆∞·ªõc t·ªëi ƒëa.", "M·∫≠t ƒë·ªô c√° th·ªÉ.", "Kh·∫£ nƒÉng ph·ª•c h·ªìi c·ªßa qu·∫ßn th·ªÉ."], correct: [0, 2, 3] },
            { type: 'single', q: "S·ª± c·∫°nh tranh gi·ªØa c√°c c√° th·ªÉ trong qu·∫ßn th·ªÉ d·∫´n ƒë·∫øn:", a: ["S·ª± ti√™u di·ªát to√†n b·ªô lo√†i.", "S·ª± ph√¢n b·ªë c√° th·ªÉ h·ª£p l√≠ h∆°n.", "S·ª± h·ªó tr·ª£ l·∫´n nhau tƒÉng l√™n.", "S·ª± bi·∫øn m·∫•t c·ªßa v·ªën gene."], correct: 1 }
        ];

        // State variables
        let db = null;
        let auth = null;
        let appId = 'sinh-hoc-12-offline';
        let isOnline = false;
        let currentIdx = 0, score = 0, sessionQuestions = [], totalTimeUsed = 0;
        let timerInterval, timeLeft = 15;
        let isGameActive = false;
        let allResults = [];

        async function setupFirebase() {
            try {
                if (typeof __firebase_config !== 'undefined') {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'sinh-hoc-12-github';
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    isOnline = true;
                    document.getElementById('online-status').classList.remove('hidden');
                    listenToLeaderboard();
                } else {
                    renderOfflineLeaderboard();
                }
            } catch (e) {
                renderOfflineLeaderboard();
            }
        }

        function listenToLeaderboard() {
            if (!db) return;
            const qRef = collection(db, 'artifacts', appId, 'public', 'data', 'top_scores');
            onSnapshot(qRef, (snap) => {
                allResults = [];
                snap.forEach(doc => allResults.push(doc.data()));
                allResults.sort((a, b) => b.score !== a.score ? b.score - a.score : a.timeUsed - b.timeUsed);
                updateLeaderboardUI();
            }, (err) => console.error("Leaderboard error:", err));
        }

        function renderOfflineLeaderboard() {
            const data = localStorage.getItem('sinh_hoc_12_scores');
            allResults = data ? JSON.parse(data) : [];
            allResults.sort((a, b) => b.score !== a.score ? b.score - a.score : a.timeUsed - b.timeUsed);
            updateLeaderboardUI();
        }

        function updateLeaderboardUI() {
            const createRow = (p, i) => `
                <div class="flex items-center justify-between p-2.5 rounded-lg ${i === 0 ? 'bg-amber-50 border border-amber-100' : 'bg-white border border-slate-100'}">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="w-5 h-5 rounded-md ${i < 3 ? 'bg-slate-800' : 'bg-slate-200'} text-white text-[9px] font-bold flex items-center justify-center shrink-0">${i+1}</span>
                        <span class="font-bold text-xs text-slate-700 truncate">${p.name}</span>
                    </div>
                    <div class="text-right shrink-0">
                        <span class="text-emerald-600 font-black text-xs">${p.score}ƒë</span>
                    </div>
                </div>`;
            const html = allResults.slice(0, 20).map(createRow).join('') || `<p class="text-slate-400 text-xs italic py-8 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>`;
            document.getElementById('leaderboard-list').innerHTML = html;
            const fl = document.getElementById('final-leaderboard'); if(fl) fl.innerHTML = html;
        }

        function renderQuestion() {
            const q = sessionQuestions[currentIdx];
            document.getElementById('question-counter').innerText = `C√¢u ${currentIdx + 1} / ${TOTAL_QS}`;
            document.getElementById('question-text').innerText = q.q;
            document.getElementById('feedback-msg').innerText = "";
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('submit-btn').classList.toggle('hidden', q.type !== 'multi');

            const grid = document.getElementById('options-grid');
            grid.innerHTML = "";
            q.a.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full p-4 text-left rounded-xl font-medium bg-white shadow-sm flex items-center gap-3 text-sm";
                btn.innerHTML = `<span class="w-6 h-6 rounded-md bg-slate-50 flex items-center justify-center text-[10px] text-slate-400 font-bold border shrink-0">${String.fromCharCode(65+i)}</span> <span class="flex-1">${opt}</span>`;
                btn.onclick = () => handleChoice(i, btn);
                grid.appendChild(btn);
            });
            window.selectedAnswers = [];
            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = TIME_LIMIT;
            timerInterval = setInterval(() => {
                timeLeft -= 0.1; totalTimeUsed += 0.1;
                if (timeLeft <= 0) { clearInterval(timerInterval); checkAnswer([], true); }
                document.getElementById('timer-bar').style.width = Math.max(0, (timeLeft / TIME_LIMIT) * 100) + "%";
            }, 100);
        }

        function handleChoice(idx, btn) {
            if (timeLeft <= 0 || !document.getElementById('next-btn').classList.contains('hidden')) return; 
            const q = sessionQuestions[currentIdx];
            if (q.type === 'multi') {
                if (window.selectedAnswers.includes(idx)) {
                    window.selectedAnswers = window.selectedAnswers.filter(x => x !== idx);
                    btn.classList.remove('option-selected');
                } else {
                    window.selectedAnswers.push(idx);
                    btn.classList.add('option-selected');
                }
            } else { clearInterval(timerInterval); checkAnswer([idx]); }
        }

        function checkAnswer(userChoices, isAuto = false) {
            const q = sessionQuestions[currentIdx];
            const feedback = document.getElementById('feedback-msg');
            let isCorrect = Array.isArray(q.correct) ? (userChoices.length === q.correct.length && userChoices.every(c => q.correct.includes(c))) : (userChoices[0] === q.correct);

            document.querySelectorAll('.option-btn').forEach((btn, i) => {
                btn.disabled = true;
                const isCorrectOpt = Array.isArray(q.correct) ? q.correct.includes(i) : i === q.correct;
                if (isCorrectOpt) btn.classList.add('correct');
                else if (userChoices.includes(i)) btn.classList.add('wrong');
            });

            if (isCorrect) { score++; feedback.innerText = "Ch√≠nh x√°c! ‚ú®"; feedback.className = "text-sm font-bold text-emerald-600"; }
            else { feedback.innerText = isAuto ? "H·∫øt gi·ªù! ‚è∞" : "Sai r·ªìi! ‚ùå"; feedback.className = "text-sm font-bold text-red-500"; }

            document.getElementById('score-display').innerText = score;
            document.getElementById('submit-btn').classList.add('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
        }

        async function finishGame(isViolation = false) {
            if (!isGameActive) return;
            isGameActive = false;
            clearInterval(timerInterval);
            
            document.getElementById('question-screen').classList.add('hidden');
            document.getElementById('quiz-header').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            document.getElementById('final-name-display').innerText = window.playerName;
            document.getElementById('final-score').innerText = `${score} / ${TOTAL_QS}`;
            
            if (isViolation) {
                document.getElementById('result-icon').innerText = "üö´";
                document.getElementById('result-title').innerText = "B√†i l√†m b·ªã h·ªßy";
                document.getElementById('violation-msg').classList.remove('hidden');
            }

            const resultData = {
                name: window.playerName + (isViolation ? " (R·ªùi trang)" : ""), 
                score: score, 
                timeUsed: parseFloat(totalTimeUsed.toFixed(1)),
                timestamp: Date.now()
            };

            if (isOnline && db) {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'top_scores'), {
                        ...resultData,
                        timestamp: serverTimestamp()
                    });
                } catch (e) { saveOffline(resultData); }
            } else {
                saveOffline(resultData);
            }
        }

        function saveOffline(data) {
            const current = JSON.parse(localStorage.getItem('sinh_hoc_12_scores') || '[]');
            current.push(data);
            localStorage.setItem('sinh_hoc_12_scores', JSON.stringify(current));
            renderOfflineLeaderboard();
        }

        // Event listeners
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && isGameActive) {
                finishGame(true);
            }
        });

        document.getElementById('start-btn').onclick = () => {
            const nameInput = document.getElementById('player-name-input');
            const name = nameInput.value.trim();
            if (!name) {
                nameInput.classList.add('shake');
                setTimeout(() => nameInput.classList.remove('shake'), 400);
                return;
            }
            
            window.playerName = name;
            sessionQuestions = [...questionsData].sort(() => Math.random() - 0.5);
            currentIdx = 0; score = 0; totalTimeUsed = 0; isGameActive = true;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-header').classList.remove('hidden');
            document.getElementById('question-screen').classList.remove('hidden');
            document.getElementById('display-name').innerText = name;
            renderQuestion();
        };

        document.getElementById('submit-btn').onclick = () => {
            if (window.selectedAnswers?.length > 0) { clearInterval(timerInterval); checkAnswer(window.selectedAnswers); }
        };

        document.getElementById('next-btn').onclick = () => {
            currentIdx++;
            if (currentIdx < TOTAL_QS) renderQuestion();
            else finishGame();
        };

        document.getElementById('back-home-btn').onclick = () => location.reload();

        // Init
        setupFirebase();
    </script>
</body>
</html>